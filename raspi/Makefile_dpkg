# Makefile for cross compiling (using Docker) of Ugglan
# for target (Raspberry Pi Zero 2 W) and building a
# Debian package.
#

RASPI_ROOT = $(shell pwd)
IMAGE_ROOT = /raspi

IMAGE_NAME = raspi_target

.DEFAULT_GOAL := build_dpkg

.PHONY: build_image build_dpkg build_dpkg_for_profiling

build_image:
	docker build --platform linux/arm/v7 \
		-f Dockerfile . -t ${IMAGE_NAME} \
		--build-arg IMAGE_ROOT=${IMAGE_ROOT}

build_dpkg: build_image
	docker run -v $(RASPI_ROOT):${IMAGE_ROOT} \
		${IMAGE_NAME} ./build_dpkg.sh

build_dpkg_for_profiling: build_image
	docker run -v $(RASPI_ROOT):${IMAGE_ROOT} \
		${IMAGE_NAME} ./build_dpkg.sh -c -pg
